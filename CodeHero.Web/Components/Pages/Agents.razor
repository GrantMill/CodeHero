@page "/agents"
@rendermode InteractiveServer

@using CodeHero.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IMcpClient Client
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav
@inject IWebHostEnvironment Env
@inject IJSRuntime JS
@inject FileStore Store
@inject RagClient Rag // RAG pipeline client

<h3>Agents</h3>

<!-- REQ-002 orchestration flow diagram -->
<div class="card mb-3">
 <div class="card-header">REQ-002 Orchestrator (planner → approval → executor → MCP)</div>
 <div class="card-body">
 <div class="row g-3">
 <div class="col-12 col-lg-7">
 <div class="mermaid">@orchestratorMmd</div>
 </div>
 <div class="col-12 col-lg-5">
 <div class="small text-muted mb-1">Prompt & Guardrails</div>
 <textarea class="form-control" style="height:45vh" readonly>@orchestratorPromptText</textarea>
 <div class="mt-2"><a href="#" @onclick="CopyOrchestratorPrompt">Copy</a></div>
 </div>
 </div>
 <div class="small text-muted mt-2">Diagram and prompt are loaded from docs/architecture.</div>
 </div>
</div>

<div class="mb-3">
 <button class="btn btn-primary" @onclick="Ping">Ping MCP</button>
 <button class="btn btn-secondary ms-2"
         @onclick="PingFoundry"
         disabled="@(foundryPingLoading)">Ping Foundry</button>
 <button class="btn btn-secondary ms-2"
         @onclick="TestPhi"
         disabled="@(foundryPhiLoading)">Test Phi</button>
 <span class="ms-2">@status</span>
</div>

@if (!string.IsNullOrEmpty(foundryPingJson))
{
    <div class="card mb-3">
        <div class="card-header">Foundry Ping Result (@foundryPingStatus)</div>
        <div class="card-body">
            @if (foundryPingLoading)
            {
                <div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div>
            }
            <pre style="white-space:pre-wrap;overflow:auto;max-height:320px">@foundryPingJson</pre>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(foundryPhiJson))
{
    <div class="card mb-3">
        <div class="card-header">Foundry Phi Test Result (@foundryPhiStatus)</div>
        <div class="card-body">
            @if (foundryPhiLoading)
            {
                <div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div>
            }
            <pre style="white-space:pre-wrap;overflow:auto;max-height:320px">@foundryPhiJson</pre>
        </div>
    </div>
}

<!-- RAG card ALWAYS rendered so input is available before first turn -->
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>RAG Conversation (rephrase → hybrid search → answer)</span>
        @if (ragLoading)
        {
            <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>
        }
    </div>
    <div class="card-body">
        <div class="input-group mb-2">
            <input class="form-control" placeholder="Ask about the app (e.g. 'What does CodeHero do?')" @bind="ragInput" />
            <button class="btn btn-primary" @onclick="AskRagAsync" disabled="@(ragLoading || string.IsNullOrWhiteSpace(ragInput))">Send</button>
            <button class="btn btn-outline-secondary" @onclick="ClearRag" disabled="@(ragLoading || ragHistory.Count==0)">Clear</button>
        </div>
        @if (!string.IsNullOrWhiteSpace(ragLastStandalone))
        {
            <div class="small text-muted mb-2">Summary: <code>@ragLastStandalone</code></div>
        }
        @if (ragHistory.Count == 0 && !ragLoading)
        {
            <div class="text-muted">No RAG turns yet. Enter a question above and click Send.</div>
        }
        @foreach (var turn in ragHistory)
        {
            <div class="mb-2">
                <div class="fw-semibold">You (@turn.Timestamp:u):</div>
                <pre class="mb-1" style="white-space:pre-wrap">@turn.User</pre>
                <div class="fw-semibold">Assistant (@turn.Timestamp:u):</div>
                <pre class="mb-1 bg-body-secondary p-2 rounded" style="white-space:pre-wrap">@turn.Assistant</pre>
            </div>
        }
        @if (!string.IsNullOrWhiteSpace(ragError))
        {
            <div class="alert alert-danger">@ragError</div>
        }
        @if (diag is not null)
        {
            <div class="mt-3">
                <h6>Diagnostic (raw responses)</h6>
                <div class="small text-muted">Rephrase (status: @diag.RephraseStatus)</div>
                <pre style="white-space:pre-wrap">@diag.RephraseRaw</pre>
                <div class="small text-muted">Search (status: @diag.SearchStatus)</div>
                <pre style="white-space:pre-wrap">@diag.SearchRaw</pre>
                <div class="small text-muted">Answer (status: @diag.AnswerStatus)</div>
                <pre style="white-space:pre-wrap">@diag.AnswerRaw</pre>
            </div>
        }
    </div>
    <div class="card-footer small text-muted">Answers may include JSON or citations. Temperature kept low for determinism.</div>
</div>

<div class="card">
 <div class="card-header">List requirements via MCP</div>
 <div class="card-body">
 <button class="btn btn-primary" @onclick="ListReqs">List .md</button>
 <ul>
 @foreach (var f in files)
 {
 <li>@f</li>
 }
 </ul>
 </div>
 <div class="card-footer text-muted">Experimental stdio client (process-based)</div>
</div>

<div class="card mt-3">
 <div class="card-header">Agents (from MCP)</div>
 <div class="card-body">
 <button class="btn btn-primary" @onclick="ListAgents">List Agents</button>
 <ul class="mt-2">
 @foreach (var a in agents)
 {
 <li>
 <span class="fw-semibold">@a</span>
 <button class="btn btn-link" @onclick="() => ShowCaps(a)">view tools</button>
 </li>
 }
 </ul>

 @if (selectedCaps is not null)
 {
 <div class="mt-3">
 <h5 class="mb-2">@selectedCaps.agent tools (@selectedCaps.tools.Count)</h5>
 @foreach (var t in selectedCaps.tools)
 {
 <div class="card mb-2">
 <div class="card-header d-flex justify-content-between align-items-center">
 <span class="fw-semibold">@t.name</span>
 <span class="text-muted small">@t.description</span>
 </div>
 <div class="card-body">
 <div class="small text-uppercase text-muted">Parameters</div>
 @if (t.parameters.HasValue && t.parameters!.Value.ValueKind == System.Text.Json.JsonValueKind.Object)
 {
 <table class="table table-sm table-striped mb-0">
 <tbody>
 @foreach (var p in t.parameters!.Value.EnumerateObject())
 {
 <tr>
 <td class="w-25"><code>@p.Name</code></td>
 <td>@(p.Value.ValueKind == System.Text.Json.JsonValueKind.String ? p.Value.GetString() : p.Value.ToString())</td>
 </tr>
 }
 </tbody>
 </table>
 }
 else
 {
 <div class="text-muted">none</div>
 }
 </div>
 </div>
 }
 </div>
 }

 <h6 class="mt-4">Scribe: Create Requirement</h6>
 <div class="row g-2">
 <div class="col"><input class="form-control" placeholder="REQ-002" @bind="newId" /></div>
 <div class="col"><input class="form-control" placeholder="Title" @bind="newTitle" /></div>
 <div class="col-auto"><button class="btn btn-primary" @onclick="CreateReq">Create</button></div>
 </div>
 @if (!string.IsNullOrEmpty(createdFile))
 {
 <div class="alert alert-info mt-2">Created: @createdFile</div>
 }
 </div>
</div>

<div class="card mt-3">
 <div class="card-header">Local agents (Web)</div>
 <div class="card-body">
 <div class="row g-3">
 <div class="col-12 col-lg-6">
 <h6 class="fw-semibold">Orchestrator</h6>
 <div class="input-group">
 <input class="form-control" placeholder="Say something…" @bind="orchestratorPrompt" />
 <button class="btn btn-primary" @onclick="SendOrchestratorAsync">Send</button>
 </div>
 @if (!string.IsNullOrWhiteSpace(orchestratorReply))
 {
 <pre class="mt-2" style="white-space:pre-wrap">@orchestratorReply</pre>
 }
 </div>
 <div class="col-12 col-lg-6">
 <h6 class="fw-semibold">Speech to Text (STT)</h6>
 <InputFile OnChange="OnAudioSelected" accept="audio/*" />
 @if (!string.IsNullOrWhiteSpace(sttText))
 {
 <div class="mt-2 alert alert-secondary">@sttText</div>
 }
 </div>
 <div class="col-12 col-lg-6">
 <h6 class="fw-semibold">Text to Speech (TTS)</h6>
 <div class="row g-2">
 <div class="col-8"><input class="form-control" placeholder="Text to synthesize" @bind="ttsText" /></div>
 <div class="col-3">
 <select class="form-select" @bind="ttsVoice">
 <option value="en-US-JennyNeural">en-US-JennyNeural</option>
 <option value="en-US-GuyNeural">en-US-GuyNeural</option>
 </select>
 </div>
 <div class="col-1"><button class="btn btn-primary w-100" @onclick="SynthesizeAsync">Go</button></div>
 </div>
 <audio class="mt-2 w-100" controls src="@ttsSrc"></audio>
 </div>
 </div>
 </div>
</div>

@code {
 string status = string.Empty;
 List<string> files = new();
 List<string> agents = new();

 // orchestrator assets
 string orchestratorMmd = string.Empty;
 string orchestratorPromptText = string.Empty;

 // structured capabilities state
 AgentCaps? selectedCaps;
 string? selectedAgent;

 string newId = "REQ-002";
 string newTitle = "New Requirement";
 string createdFile = string.Empty;

 // local agents state
 string orchestratorPrompt = string.Empty;
 string orchestratorReply = string.Empty;
 string sttText = string.Empty;
 string ttsText = string.Empty;
 string ttsVoice = "en-US-JennyNeural";
 string? ttsSrc;

 // Diagnostics for Foundry ping
 bool foundryPingLoading = false;
 string foundryPingJson = string.Empty;
 string foundryPingStatus = string.Empty;

 bool foundryPhiLoading = false;
 string foundryPhiJson = string.Empty;
 string foundryPhiStatus = string.Empty;

 // RAG state
 List<ChatTurn> ragHistory = new();
 string ragInput = string.Empty;
 bool ragLoading = false;
 string ragLastStandalone = string.Empty; // extracted from first line if JSON includes summary
 string? ragError;
 DiagnosticAnswerResponse? diag;

 // Prompts & guardrails (.agent)
 List<string> roleFiles = new();
 List<string> toolFiles = new();
 string? selectedPromptText;
 string? selectedPromptPath;

 protected override void OnInitialized()
 {
 // Discover .agent files
 try
 {
 var root = Env.ContentRootPath;
 var roles = Path.Combine(root, ".agent", "roles");
 var tools = Path.Combine(root, ".agent", "tools");
 if (Directory.Exists(roles)) roleFiles = Directory.EnumerateFiles(roles, "*.*", SearchOption.TopDirectoryOnly)
 .Where(f => f.EndsWith(".yml", StringComparison.OrdinalIgnoreCase) || f.EndsWith(".yaml", StringComparison.OrdinalIgnoreCase) || f.EndsWith(".md", StringComparison.OrdinalIgnoreCase))
 .OrderBy(Path.GetFileName).ToList();
 if (Directory.Exists(tools)) toolFiles = Directory.EnumerateFiles(tools, "*.*", SearchOption.TopDirectoryOnly)
 .Where(f => f.EndsWith(".yml", StringComparison.OrdinalIgnoreCase) || f.EndsWith(".yaml", StringComparison.OrdinalIgnoreCase) || f.EndsWith(".md", StringComparison.OrdinalIgnoreCase))
 .OrderBy(Path.GetFileName).ToList();
 }
 catch { }

 // Load architecture assets
 try { orchestratorMmd = Store.ReadText(StoreRoot.Architecture, "orchestrator.mmd", ".mmd", ".md"); }
 catch { orchestratorMmd = "flowchart LR\nA[missing orchestrator.mmd]"; }
 try { orchestratorPromptText = Store.ReadText(StoreRoot.Architecture, "orchestrator.prompt.md", ".md", ".txt"); }
 catch { orchestratorPromptText = string.Empty; }
 }

 void LoadPrompt(string path)
 {
 try { selectedPromptText = System.IO.File.ReadAllText(path); selectedPromptPath = path; }
 catch { selectedPromptText = ""; selectedPromptPath = path; }
 }

 async Task CopyPrompt()
 {
 try { await JS.InvokeVoidAsync("navigator.clipboard.writeText", selectedPromptText ?? string.Empty); } catch { }
 }

 async Task CopyOrchestratorPrompt()
 {
 try { await JS.InvokeVoidAsync("navigator.clipboard.writeText", orchestratorPromptText ?? string.Empty); } catch { }
 }

 async Task Ping()
 {
 try
 {
 if (await Client.InitializeAsync())
 {
 status = await Client.PingAsync() ? "pong" : "no pong";
 }
 else status = "init failed";
 }
 catch (Exception ex)
 {
 status = ex.Message;
 }
 }

 async Task PingFoundry()
 {
     try
     {
         foundryPingLoading = true;
         foundryPingJson = string.Empty;
         foundryPingStatus = string.Empty;
         var http = HttpFactory.CreateClient();
         if (http.BaseAddress is null) http.BaseAddress = new Uri(Nav.BaseUri, UriKind.Absolute);
         var resp = await http.GetAsync("diagnostics/foundry/ping");
         var text = await resp.Content.ReadAsStringAsync();
         if (resp.IsSuccessStatusCode)
         {
             try
             {
                 using var doc = System.Text.Json.JsonDocument.Parse(text);
                 foundryPingJson = System.Text.Json.JsonSerializer.Serialize(doc, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
             }
             catch
             {
                 foundryPingJson = text;
             }
             foundryPingStatus = resp.StatusCode.ToString();
         }
         else
         {
             foundryPingJson = text;
             foundryPingStatus = $"Error {(int)resp.StatusCode}";
         }
     }
     catch (Exception ex)
     {
         foundryPingJson = ex.ToString();
         foundryPingStatus = "Exception";
     }
     finally
     {
         foundryPingLoading = false;
         StateHasChanged();
     }
 }

 async Task TestPhi()
 {
     try
     {
         foundryPhiLoading = true;
         foundryPhiJson = string.Empty;
         foundryPhiStatus = string.Empty;

         var prompt = "Explain what the application does.";

         // Use a direct SocketsHttpHandler + HttpClient to avoid global resilience handlers on the default factory client
         using var handler = new System.Net.Http.SocketsHttpHandler
         {
             AutomaticDecompression = System.Net.DecompressionMethods.GZip | System.Net.DecompressionMethods.Deflate,
             PooledConnectionLifetime = TimeSpan.FromMinutes(10),
             Expect100ContinueTimeout = TimeSpan.Zero,
             UseProxy = false
         };

         using var client = new HttpClient(handler) { Timeout = Timeout.InfiniteTimeSpan };
         if (client.BaseAddress is null) client.BaseAddress = new Uri(Nav.BaseUri, UriKind.Absolute);
         client.DefaultRequestVersion = System.Net.HttpVersion.Version11;

         using var content = new StringContent(prompt, System.Text.Encoding.UTF8, "text/plain");
         using var resp = await client.PostAsync("api/agent/phi-test", content);
         var text = await resp.Content.ReadAsStringAsync();

         if (resp.IsSuccessStatusCode)
         {
             try
             {
                 using var doc = System.Text.Json.JsonDocument.Parse(text);
                 // Try to extract assistant content at choices[0].message.content
                 if (doc.RootElement.TryGetProperty("choices", out var choices) && choices.GetArrayLength() > 0)
                 {
                     var first = choices[0];
                     if (first.TryGetProperty("message", out var msg) && msg.TryGetProperty("content", out var contentEl) && contentEl.ValueKind == System.Text.Json.JsonValueKind.String)
                     {
                         foundryPhiJson = contentEl.GetString() ?? string.Empty;
                     }
                     else
                     {
                         foundryPhiJson = System.Text.Json.JsonSerializer.Serialize(doc, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
                     }
                 }
                 else
                 {
                     foundryPhiJson = System.Text.Json.JsonSerializer.Serialize(doc, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
                 }
             }
             catch
             {
                 foundryPhiJson = text;
             }
             foundryPhiStatus = resp.StatusCode.ToString();
         }
         else
         {
             foundryPhiJson = text;
             foundryPhiStatus = $"Error {(int)resp.StatusCode}";
         }
     }
     catch (Exception ex)
     {
         foundryPhiJson = ex.ToString();
         foundryPhiStatus = "Exception";
     }
     finally
     {
         foundryPhiLoading = false;
         StateHasChanged();
     }
 }

 async Task AskRagAsync()
 {
     if (string.IsNullOrWhiteSpace(ragInput) || ragLoading) return;
     ragLoading = true;
     ragError = null;
     diag = null;
     try
     {
         var d = await Rag.AskDiagnosticAsync(ragInput, ragHistory, CancellationToken.None);
         diag = d;
         try { Rag.LastDiagnostic = d; } catch { }

         var now = DateTimeOffset.UtcNow;

         // 1) add rephrase result
         var rephraseText = string.IsNullOrWhiteSpace(d.RephraseRaw) ? "(no rephrase)" : d.RephraseRaw;
         ragHistory.Add(new ChatTurn("(rephrase)", rephraseText, now));

         // 2) add search results
         var searchText = string.IsNullOrWhiteSpace(d.SearchRaw) ? "(no search)" : d.SearchRaw;
         ragHistory.Add(new ChatTurn("(search)", searchText, now));

         // 3) show the actual payload sent to the answer endpoint (input to final model)
         var answerReqJson = d.AnswerRequestJson ?? "(no answer request json)";
         ragHistory.Add(new ChatTurn("(answer request)", answerReqJson, now));

         // 4) final answer
         if (d.ParsedAnswer is not null)
         {
             var final = d.ParsedAnswer.Output ?? string.Empty;
             ragHistory.Add(new ChatTurn("(final answer)", final, now));

             if (final.StartsWith('{'))
             {
                 try
                 {
                     using var doc = System.Text.Json.JsonDocument.Parse(final);
                     if (doc.RootElement.TryGetProperty("summary", out var sumEl) && sumEl.ValueKind == System.Text.Json.JsonValueKind.String)
                         ragLastStandalone = sumEl.GetString() ?? string.Empty;
                 }
                 catch { }
             }
         }
         else
         {
             var fallback = d.AnswerRaw ?? "(no answer)";
             ragHistory.Add(new ChatTurn("(final answer)", fallback, now));
         }

         // Add original user turn
         ragHistory.Add(new ChatTurn(ragInput, string.Empty, now));

         ragInput = string.Empty;
     }
     catch (Exception ex)
     {
         ragError = ex.Message;
     }
     finally
     {
         ragLoading = false;
         StateHasChanged();
     }
 }

 async Task AskRagDiagnosticAsync()
 {
     if (string.IsNullOrWhiteSpace(ragInput) || ragLoading) return;
     ragLoading = true;
     ragError = null;
     diag = null;
     try
     {
         var d = await Rag.AskDiagnosticAsync(ragInput, ragHistory, CancellationToken.None);
         diag = d;
         try { Rag.LastDiagnostic = d; } catch { }

         var now = DateTimeOffset.UtcNow;

         if (d.ParsedAnswer is not null)
         {
             if (d.ParsedAnswer.Output.StartsWith('{'))
             {
                 try
                 {
                     using var doc = System.Text.Json.JsonDocument.Parse(d.ParsedAnswer.Output);
                     if (doc.RootElement.TryGetProperty("summary", out var sumEl) && sumEl.ValueKind == System.Text.Json.JsonValueKind.String)
                         ragLastStandalone = sumEl.GetString() ?? string.Empty;
                 }
                 catch { }
             }

             ragHistory.Add(new ChatTurn(ragInput, d.ParsedAnswer.Output, now));
         }
         else
         {
             ragHistory.Add(new ChatTurn(ragInput, d.AnswerRaw ?? "(no answer)", now));
         }

         ragInput = string.Empty;
     }
     catch (Exception ex)
     {
         ragError = ex.Message;
     }
     finally
     {
         ragLoading = false;
         StateHasChanged();
     }
 }

 void ClearRag()
 {
     ragHistory.Clear();
     ragLastStandalone = string.Empty;
     ragError = null;
 }

 async Task ListReqs()
 {
 try
 {
 if (await Client.InitializeAsync())
 {
 files = (await Client.ListAsync(StoreRoot.Requirements, new[] { ".md" })).ToList();
 }
 }
 catch (Exception ex)
 {
 status = ex.Message;
 }
 }

 async Task ListAgents()
 {
 try
 {
 if (await Client.InitializeAsync())
 {
 agents = (await Client.ListAgentsAsync()).ToList();
 }
 }
 catch (Exception ex)
 {
 status = ex.Message;
 }
 }

 async Task ShowCaps(string agent)
 {
 try
 {
 if (await Client.InitializeAsync())
 {
 var capsEl = await Client.GetAgentCapabilitiesAsync(agent);
 selectedCaps = System.Text.Json.JsonSerializer.Deserialize<AgentCaps>(capsEl.GetRawText(), new System.Text.Json.JsonSerializerOptions(System.Text.Json.JsonSerializerDefaults.Web));
 selectedAgent = agent;
 }
 }
 catch (Exception ex)
 {
 status = ex.Message;
 }
 }

 async Task CreateReq()
 {
 try
 {
 if (await Client.InitializeAsync())
 {
 createdFile = await Client.ScribeCreateRequirementAsync(newId, newTitle);
 }
 }
 catch (Exception ex)
 {
 status = ex.Message;
 }
 }

 async Task SendOrchestratorAsync()
 {
 try
 {
 var http = HttpFactory.CreateClient();
 if (http.BaseAddress is null) http.BaseAddress = new Uri(Nav.BaseUri, UriKind.Absolute);
 var resp = await http.PostAsync("api/agent/chat", new StringContent(orchestratorPrompt));
 orchestratorReply = resp.IsSuccessStatusCode ? (await resp.Content.ReadAsStringAsync()) : resp.StatusCode.ToString();
 }
 catch (Exception ex)
 {
 orchestratorReply = ex.Message;
 }
 }

 async Task OnAudioSelected(InputFileChangeEventArgs e)
 {
 try
 {
 var file = e.File;
 using var ms = new MemoryStream();
 await file.OpenReadStream(maxAllowedSize:20 *1024 *1024).CopyToAsync(ms);
 var http = HttpFactory.CreateClient();
 if (http.BaseAddress is null) http.BaseAddress = new Uri(Nav.BaseUri, UriKind.Absolute);
 using var content = new ByteArrayContent(ms.ToArray());
 content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("audio/wav");
 var resp = await http.PostAsync("api/stt", content);
 sttText = resp.IsSuccessStatusCode ? (await resp.Content.ReadAsStringAsync()) : resp.StatusCode.ToString();
 }
 catch (Exception ex)
 {
 sttText = ex.Message;
 }
 }

 async Task SynthesizeAsync()
 {
 try
 {
 var http = HttpFactory.CreateClient();
 if (http.BaseAddress is null) http.BaseAddress = new Uri(Nav.BaseUri, UriKind.Absolute);
 var resp = await http.PostAsync($"api/tts?voice={Uri.EscapeDataString(ttsVoice)}", new StringContent(ttsText));
 if (resp.IsSuccessStatusCode)
 {
 var bytes = await resp.Content.ReadAsByteArrayAsync();
 ttsSrc = "data:audio/wav;base64," + Convert.ToBase64String(bytes);
 }
 else
 {
 ttsSrc = null; status = resp.StatusCode.ToString();
 }
 }
 catch (Exception ex)
 {
 ttsSrc = null; status = ex.Message;
 }
 }

 // DTOs for capabilities
 private sealed class AgentCaps
 {
 public string agent { get; set; } = string.Empty;
 public List<ToolDef> tools { get; set; } = new();
 }
 private sealed class ToolDef
 {
 public string name { get; set; } = string.Empty;
 public string? description { get; set; }
 public System.Text.Json.JsonElement? parameters { get; set; }
 }
}